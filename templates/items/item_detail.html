{% extends "layouts/default.html" %}
{% load static %}
{% load humanize %}
 
{% block title %}{{ title }}{% endblock %}
 
{% block content %}
        <div class="container">
            <div class="row">
                <div class="col-5 offset-1 mb-5">
                    {% with item.item_images.all.0 as first_image %}
                       <img class="rounded img-fluid auto" src="{{ first_image.image.url }}">
                    {% endwith %}
            	</div>
                <div class="col-6 mb-5">
                    <div class="row">
                        <div class="d-flex flex-row bd-highlight ml-4 mb-5">
                             {% for image in item.item_images.all %}
                			     {%if forloop.first %}
                                 {% else %}
                            		 <div id="gallery">
                            			 <img class="justify-content-start rounded" src="{{ image.image.url }}">
                            		</div>
                            	{% endif %}
                            {% endfor %}
                        </div>
                    </div>
                    <div class="row">
                         <div class="col-12">
                            <div class="d-flex justify-content-end item_upper_icons"> 
                                {% if user.is_authenticated %}
                                    <button class="bg-transparent border-0 " onclick="addToFavoritesAsync(this, '{{ item.pk }}')">
        						    	{% if item in favorite_items %}
        						        <img src="{% static 'images/icon/favorite_pink_icon.png' %}" alt="お気に入り">
        						        {% else %}
        						        <img src="{% static 'images/icon/favorite_icon.png' %}" alt="お気に入り">
        						        {% endif %}
    						        </button>    
            					{% else %}
            					    <div class="d-flex justify-content-end item_upper_icons">
            				            <a onclick="showLoginModal();">
            				                <img src="{% static 'images/icon/favorite_icon.png' %}" alt="お気に入り">
            				            </a>
            				        </div>
        				        {% endif %}
    				        </div>

                            <h2 class="font-weight-bold">{{ item.name }}</h2>
                            <p class="ml-5">{{ item.description }}</p>
                            <div class="text-right">税込価格：{{ item.price | intcomma }}円</div>
                            <div class="text-right mb-3">
                                <small>
                                    (内税{{ item.tax_percent }}%：
                                    {% if item.tax_percent == 8 %} 
                                        {{ tax8 | intcomma }}円)
                                    {% else %}
                                        {{ tax10 | intcomma }}円)
                                    {% endif %}
                                </small>
                            </div>
                            <div class="row">
                                <div class="col-12 d-flex flex-row justify-content-end">
                                    <p class="text-right mr-2">個数</p>
                                        
                                    <form method="post" action="{% url 'items:add_item' item.pk %}">
                                        {% csrf_token %}
                                        <div class="col-sm d-flex flex-row justify-content-end px-0">
                                            <div class="spinner-container">
                                                <span class="spinner-sub disabled">-</span>
                                                <input class="spinner" type="number" min="1" max="50" value="1" name="amount">
                                                <span class="spinner-add">+</span>
                                            </div>
                                            <button type="submit" class="btn btn-secondary ml-2" name="button">
                                            カートに入れる
                                            </button> 
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row mt-5">
                <div class="col-5 offset-1 mb-5">
                    <h2>産地情報等</h2>
                    <p class="ml-5">{{item.area.description}}</p>
                </div>
                <div class="col-5 mt-5 mb-5 ml-auto">
                    <img class="rounded img-fluid auto" src="{{ item.area.area_image.url }}">
                </div>
            </div>
            {% include "items/review_list.html" %}   
        </div>
        <div class="return_link d-flex justify-content-center">
            <button class="btn" onclick="window.history.back();return false;">＜ 戻る</button>
        </div>
        {% load static %}
        <script src="{% static 'js/spinner_script.js' %}"></script>
        
        <script>
		var isAuthenticated = ('{{user.is_authenticated}}' == "True");
		const csrf_token = '{{csrf_token}}';
	
		function showLoginModal() {
			// ログインしていない場合はモーダルを表示
			if (!isAuthenticated) {
				$('#loginModal').modal('show');
				return false;  
			}
			return true;  // ログインしている場合は通常の動作を続行
		}
	
	
		async function addToFavoritesAsync(button, itemId) {
		    if (itemId == undefined || itemId == null)
		        return;
		
		    const formData = new FormData();
		    // formData.append('amount', amount.toString());
		
		    const request =  createRequest(formData);
		    const url = "{% url 'items:favorite_add' 11111 %}".replace("11111", itemId);
		    const succeed = await sendRequestAsync(url, request);
		
		    if (button) {
		        const successColor = '#8ff0a4';
		        const failColor = 'lightred';
		
		        const imgIcon = button.querySelector('img');
		        const addFavoriteIcon = "{% static 'images/icon/favorite_pink_icon.png' %}";
		        const removeFavoriteIcon = "{% static 'images/icon/favorite_icon.png' %}";
		
		        if (succeed) {
		            highlightButton(button, successColor, 1.25);
		
		            if (imgIcon && imgIcon.src.includes(removeFavoriteIcon))
		                imgIcon.src = addFavoriteIcon;
		            else if (imgIcon && imgIcon.src.includes(addFavoriteIcon))
		                imgIcon.src = removeFavoriteIcon;
		        }
		        else
		            highlightButton(button, failColor, 1.25);
		    }
		}
		// 	simulateAsyncRequest().then(() => {
		// 		icon.classList.toggle('favorited');
		// 	});
		// }
	
		function highlightButton(button, color='#8ff0a4', highlightSeconds=1) {
			button.style = `box-shadow: 0px 0px 10px 12px ${color} inset;`;
			setTimeout(() => {
				button.style = '';
			}, highlightSeconds * 1000);
		}
	
		function createRequest(formData) {
			const requestHeaders = {'X-CSRFToken': `${csrf_token}`};
			const request = {
				headers: requestHeaders,
				method: 'POST',
				body: formData
			}
			return request;
		}
	
		async function sendRequestAsync(url, request) {
			try {
				const response = await fetch(url, request);
				if (!response.ok) {
					const reason = await response.json();
					if (reason.message || reason.statusText)
						console.error(reason.message || reason.statusText);
					console.error("request failed");
					console.error('Url', url);
					console.error('Request', request);
				}
	
				return true;
			} catch(err) {
				console.error(err);
				console.error("request failed!");
				console.error('Url', url);
				console.error('Method:', request.method);
				console.error('Headers:', request.headers);
				console.error('Data', request.body);
			}
	
			return false;
		}
	</script>
{% endblock %}
