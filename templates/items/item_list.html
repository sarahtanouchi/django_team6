{% extends "layouts/default.html" %}
{% load static %}
{% load humanize %}

{% block additional_css %}
<link rel="stylesheet" href="{% static 'stylesheets/home.css' %}">
{% endblock %}

{% block content %}
    <div class="container">
		<h2>商品を絞り込む</h2>
	    {% include "includes/filter.html" %}
	    
		<h2>商品一覧</h2>
		<div class="row ml-4">
			{% for item in item_list %}
				<div class="col-3 mb-4">
					<ul class="item_upper_icons">
						<!-- お気に入り追加 -->
						<li class="item_favorite_icon">
						    {% if user.is_authenticated %}
						    <button class="bg-transparent border-0" onclick="addToFavoritesAsync(this, '{{ item.pk }}')">
						    	{% if item in favorite_items %}
						        <img src="{% static 'images/icon/favorite_pink_icon.png' %}" alt="お気に入り">
						        {% else %}
						        <img src="{% static 'images/icon/favorite_icon.png' %}" alt="お気に入り">
						        {% endif %}
						    </button>
						    {% else %}
						    <button class="bg-transparent border-0" onclick="showLoginModal()">
						        <img src="{% static 'images/icon/favorite_icon.png' %}" alt="お気に入り">
						    </button>
						    {% endif %}
						</li>
						<!-- カート追加 -->
						<li class="item_cart_icon">
						    {% if user.is_authenticated %}
						    <button class="bg-transparent border-0" onclick="addToCartAsync(this, '{{ item.pk }}')">
						        <img src="{% static 'images/icon/cart_icon.png' %}" alt="カート">
						    </button>
						    {% else %}
						    <button class="bg-transparent border-0" onclick="showLoginModal()">
						        <img src="{% static 'images/icon/cart_icon.png' %}" alt="カート">
						    </button>
						    {% endif %}
						</li>
					</ul>
					
		             <!--モーダル-->
				    <div class="modal fade" id="loginModal" tabindex="-1" role="dialog" aria-labelledby="loginModalLabel" aria-hidden="true">
				        <div class="modal-dialog" role="document">
				            <div class="modal-content">
				                <div class="modal-header">
				                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
				                        <span aria-hidden="true">&times;</span>
				                    </button>
				                </div>
				                <div class="modal-body" style="text-align: center;">
				                    <h5 class="modal-title" id="loginModalLabel">ログインしてください</h5>
				                    <button class="btn btn_lg btn_gray">
				                        <a href="{% url 'accounts:login' %}" >ログイン</a>
				                    </button>
				                </div>
				            </div>
				        </div>
				    </div>
		             
		             <div>   
						{% if item.item_images %}
			    			{% with item.item_images.all.0 as image %}
			    			<figure>
		    					<a href="{% url 'items:item_detail' item.id %}">
			    					<img class="item_image img-fluid rounded" src="{{ image.image.url }}">
				    			</a>
				    			<div class="item_tag_row">
				    				<span class="item_tag">
				    					{% if item.taste %}
			    							{{ item.tea_type }}
				    					{% else %}
				    						{{ item.item_type }}
				    					{% endif %}
				    				</span>
				    				<span class="item_tag">
				    					{% if item.taste %}
		    								{{ item.taste }}
			    						{% else %}
			    							{{ item.occasion }}
			    						{% endif %}	
				    				</span>
				    			</div>
				    			<figcaption>
				    				<div class="recommend_item_name">
				    					<a href="{% url 'items:item_detail' item.id %}">
                                            <small>{{ item.name }}</small>
                                        </a>
                                        <small>{{ item.price | intcomma }}円(税込)</small>
				    				</div>
				    			</figcaption>
				    		</figure>
                    		{% endwith %}
                		{% else %}
                			{% load static %}
                    		<img class="item_image" src="{% static 'images/no_image.jpg' %}">
                    	{% endif %}
					</div>
				</div>
			{% empty %}
            	<p>出品商品はありません。</p>
			{% endfor %}
		</div>
		{% include "includes/pagination.html" %}
	</div>
	
	<script>
		var isAuthenticated = ('{{user.is_authenticated}}' == "True");
		const csrf_token = '{{csrf_token}}';
	
		function showLoginModal() {
			// ログインしていない場合はモーダルを表示
			if (!isAuthenticated) {
				$('#loginModal').modal('show');
				return false;  
			}
			return true;  // ログインしている場合は通常の動作を続行
		}
	
		async function addToCartAsync(button, itemId, amount=1) {
			if (itemId == undefined || itemId == null)
				return;
	
			const formData = new FormData();
			formData.append('amount', amount.toString());
			
			const request =  createRequest(formData);
			const url = "{% url 'items:add_item' 11111 %}".replace("11111", itemId);
			const succeed = await sendRequestAsync(url, request);
	
			if (button) {
				const successColor = '#8ff0a4';
				const failColor = 'lightred';
				if (succeed)
					highlightButton(button, successColor, 1.25);
				else
					highlightButton(button, failColor, 1.25);
			}
		}
		async function addToFavoritesAsync(button, itemId) {
		    if (itemId == undefined || itemId == null)
		        return;
		
		    const formData = new FormData();
		    // formData.append('amount', amount.toString());
		
		    const request =  createRequest(formData);
		    const url = "{% url 'items:favorite_add' 11111 %}".replace("11111", itemId);
		    const succeed = await sendRequestAsync(url, request);
		
		    if (button) {
		        const successColor = '#8ff0a4';
		        const failColor = 'lightred';
		
		        const imgIcon = button.querySelector('img');
		        const addFavoriteIcon = "{% static 'images/icon/favorite_pink_icon.png' %}";
		        const removeFavoriteIcon = "{% static 'images/icon/favorite_icon.png' %}";
		
		        if (succeed) {
		            highlightButton(button, successColor, 1.25);
		
		            if (imgIcon && imgIcon.src.includes(removeFavoriteIcon))
		                imgIcon.src = addFavoriteIcon;
		            else if (imgIcon && imgIcon.src.includes(addFavoriteIcon))
		                imgIcon.src = removeFavoriteIcon;
		        }
		        else
		            highlightButton(button, failColor, 1.25);
		    }
		}
		// 	simulateAsyncRequest().then(() => {
		// 		icon.classList.toggle('favorited');
		// 	});
		// }
	
		// 非同期リクエストを模倣する関数
		function simulateAsyncRequest() {
			return new Promise(resolve => {
				// 仮の非同期処理（実際にはAjaxなどを使用する）
				setTimeout(resolve, 1000);
			});
		}
	
		function highlightButton(button, color='#8ff0a4', highlightSeconds=1) {
			button.style = `box-shadow: 0px 0px 10px 12px ${color} inset;`;
			setTimeout(() => {
				button.style = '';
			}, highlightSeconds * 1000);
		}
	
		function createRequest(formData) {
			const requestHeaders = {'X-CSRFToken': `${csrf_token}`};
			const request = {
				headers: requestHeaders,
				method: 'POST',
				body: formData
			}
			return request;
		}
	
		async function sendRequestAsync(url, request) {
			try {
				const response = await fetch(url, request);
				if (!response.ok) {
					const reason = await response.json();
					if (reason.message || reason.statusText)
						console.error(reason.message || reason.statusText);
					console.error("request failed");
					console.error('Url', url);
					console.error('Request', request);
				}
	
				return true;
			} catch(err) {
				console.error(err);
				console.error("request failed!");
				console.error('Url', url);
				console.error('Method:', request.method);
				console.error('Headers:', request.headers);
				console.error('Data', request.body);
			}
	
			return false;
		}
	</script>
{% endblock %}
